name: ðŸš€ Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '21'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@marant7'
        
    - name: ðŸ§ª Test ATM App
      working-directory: atm
      run: |
        npm ci
        npm run test:cov
        npm run build
        
    - name: ðŸ§ª Test Payment App
      working-directory: payment
      run: |
        npm ci
        npm run test:cov
        npm run build
        
    - name: ðŸ·ï¸ Get Version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        # Remove 'v' prefix if present
        VERSION=$(echo $VERSION | sed 's/^v//')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Selected version: $VERSION"
        
    - name: ðŸ“¦ Create ATM Package
      working-directory: atm
      run: |
        # Set version in package.json
        npm version ${{ steps.get_version.outputs.VERSION }} --no-git-tag-version
        
        # Configure package for GitHub
        node -e "
          const pkg = require('./package.json');
          pkg.name = '@marant7/atm_marant';
          delete pkg.private;
          pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
          pkg.repository = {
            type: 'git',
            url: 'git+https://github.com/${{ github.repository }}.git'
          };
          pkg.author = 'Mario Antonio Flores Ramos';
          pkg.description = 'ATM System implementing Command Design Pattern - Lab 03';
          pkg.keywords = ['command', 'design-pattern', 'atm', 'banking', 'nestjs', 'typescript'];
          require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
        "
        
        # Create package
        npm pack
        
        # Find the exact filename and store it
        PACKAGE_FILE=$(ls *.tgz | head -1)
        echo "ATM_PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_ENV
        echo "ATM package file: $PACKAGE_FILE"
        
    - name: ðŸ“¦ Create Payment Package
      working-directory: payment
      run: |
        # Set version in package.json
        npm version ${{ steps.get_version.outputs.VERSION }} --no-git-tag-version
        
        # Configure package for GitHub
        node -e "
          const pkg = require('./package.json');
          pkg.name = '@marant7/payment_marant';
          delete pkg.private;
          pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
          pkg.repository = {
            type: 'git',
            url: 'git+https://github.com/${{ github.repository }}.git'
          };
          pkg.author = 'Mario Antonio Flores Ramos';
          pkg.description = 'Payment System implementing Strategy Design Pattern - Lab 03';
          pkg.keywords = ['strategy', 'design-pattern', 'payment', 'credit-card', 'nestjs', 'typescript'];
          require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
        "
        
        # Create package
        npm pack
        
        # Find the exact filename and store it
        PACKAGE_FILE=$(ls *.tgz | head -1)
        echo "PAYMENT_PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_ENV
        echo "Payment package file: $PACKAGE_FILE"
        
    - name: ðŸ“‹ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_PACKAGE }}
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        release_name: ðŸŽ‰ Release v${{ steps.get_version.outputs.VERSION }} - Patrones de Comportamiento
        body: |
          ## ðŸŽ¯ Patrones de DiseÃ±o de Comportamiento - Lab 03
          
          **Autor:** Mario Antonio Flores Ramos
          **VersiÃ³n:** ${{ steps.get_version.outputs.VERSION }}
          **Fecha:** $(date '+%d/%m/%Y')
          
          ### ðŸ“¦ Paquetes Incluidos
          - `@marant7/atm_marant@${{ steps.get_version.outputs.VERSION }}`: Sistema ATM con patrÃ³n Command
          - `@marant7/payment_marant@${{ steps.get_version.outputs.VERSION }}`: Sistema de Pagos con patrÃ³n Strategy
          
          ### ðŸ—ï¸ Patrones Implementados
          
          #### ðŸ§ PatrÃ³n Command (ATM System)
          - **PropÃ³sito**: Encapsula operaciones bancarias como objetos ejecutables
          - **Componentes**: Command, ConcreteCommand, Invoker, Receiver
          - **Operaciones**: DepÃ³sitos y retiros bancarios
          - **Beneficios**: Desacoplamiento, extensibilidad, posible implementaciÃ³n de undo/redo
          
          #### ðŸ’³ PatrÃ³n Strategy (Payment System)  
          - **PropÃ³sito**: Permite intercambiar algoritmos de pago dinÃ¡micamente
          - **Componentes**: Strategy, ConcreteStrategy, Context
          - **MÃ©todos**: Efectivo, Tarjeta de CrÃ©dito, Tarjeta de DÃ©bito
          - **Beneficios**: Flexibilidad, extensibilidad, principio abierto/cerrado
          
          ### ðŸ› ï¸ InstalaciÃ³n desde GitHub Packages
          ```bash
          # Configurar registry para @marant7 scope
          echo "@marant7:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=YOUR_GITHUB_TOKEN" >> .npmrc
          
          # Instalar paquetes
          npm install @marant7/atm_marant@${{ steps.get_version.outputs.VERSION }}
          npm install @marant7/payment_marant@${{ steps.get_version.outputs.VERSION }}
          ```
          
          ### ðŸ“¥ InstalaciÃ³n desde archivos .tgz
          TambiÃ©n puedes descargar los archivos .tgz de esta release e instalar localmente:
          ```bash
          npm install ./atm_marant-v${{ steps.get_version.outputs.VERSION }}.tgz
          npm install ./payment_marant-v${{ steps.get_version.outputs.VERSION }}.tgz
          ```
          
          ### ðŸ§ª Cobertura de Pruebas
          - âœ… Tests unitarios con Jest
          - ðŸ“Š AnÃ¡lisis de cÃ³digo con SonarCloud
          - ðŸ“š DocumentaciÃ³n generada con Compodoc
          - ðŸš€ CI/CD automÃ¡tico con GitHub Actions
          
          ### ðŸ”— Enlaces Ãštiles
          - ðŸ“š [DocumentaciÃ³n](https://marant7.github.io/lab-2025-i-pds-u2-03-nest-Marant7/)
          - ðŸ“Š [AnÃ¡lisis ATM](https://sonarcloud.io/project/overview?id=apistestlabs_atm)
          - ðŸ“Š [AnÃ¡lisis Payment](https://sonarcloud.io/project/overview?id=apistestlabs_payment)
          - ðŸ“¦ [GitHub Packages](https://github.com/Marant7?tab=packages)
        draft: false
        prerelease: false
        
    - name: ðŸ“¤ Upload ATM Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_PACKAGE }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./atm/${{ env.ATM_PACKAGE_FILE }}
        asset_name: atm_marant-v${{ steps.get_version.outputs.VERSION }}.tgz
        asset_content_type: application/gzip
        
    - name: ðŸ“¤ Upload Payment Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_PACKAGE }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./payment/${{ env.PAYMENT_PACKAGE_FILE }}
        asset_name: payment_marant-v${{ steps.get_version.outputs.VERSION }}.tgz
        asset_content_type: application/gzip
        
    - name: ðŸŽ‰ Release Summary
      run: |
        echo "## ðŸŽ‰ Release v${{ steps.get_version.outputs.VERSION }} Creado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Paquetes publicados:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ **@marant7/atm_marant@${{ steps.get_version.outputs.VERSION }}** (Command Pattern)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’³ **@marant7/payment_marant@${{ steps.get_version.outputs.VERSION }}** (Strategy Pattern)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Enlaces:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ [Ver Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ [Ver Packages](https://github.com/Marant7?tab=packages)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š [DocumentaciÃ³n](https://marant7.github.io/lab-2025-i-pds-u2-03-nest-Marant7/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Archivos generados:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.ATM_PACKAGE_FILE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.PAYMENT_PACKAGE_FILE }}\`" >> $GITHUB_STEP_SUMMARY